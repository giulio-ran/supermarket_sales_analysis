<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/><style>
table {border: medium solid #6495ed;border-collapse: collapse;width: 100%;} th{font-family: monospace;border: thin solid #6495ed;padding: 5px;background-color: #D0E3FA;}th{text-align: left;}td{font-family: sans-serif;border: thin solid #6495ed;padding: 5px;text-align: center;}.odd{background:#e8edff;}img{padding:5px; border:solid; border-color: #dddddd #aaaaaa #aaaaaa #dddddd; border-width: 1px 2px 2px 1px; background-color:white;}</style>
</head>
<body>
<table><tr><th colspan="5"><pre><code>/* Customer Retention analysis */<br>WITH FirstOrders AS (<br>    SELECT <br>        s.customer_id, <br>        MIN(o.order_date) AS first_purchase_date,<br>        YEAR(MIN(o.order_date)) AS cohort_year<br>    FROM sales s <br>    join orders o on o.order_id = s.order_id <br>    GROUP BY s.customer_id<br>),<br>SecondOrders AS (<br>    SELECT <br>        s.customer_id, <br>        MIN(o.order_date) AS second_purchase_date<br>    FROM sales s<br>    join orders o on o.order_id = s.order_id<br>    JOIN FirstOrders f ON s.customer_id = f.customer_id<br>    WHERE o.order_date &gt; f.first_purchase_date<br>    GROUP BY s.customer_id<br>)<br>SELECT <br>    f.cohort_year AS `Acquition year (Cohort)`,<br>    COUNT(f.customer_id) AS `Total aquired customers`,<br>    ROUND(AVG(DATEDIFF(s.second_purchase_date, f.first_purchase_date)), 0) AS `Average days to second order`,<br>    ROUND((COUNT(s.second_purchase_date) / COUNT(f.customer_id)) * 100, 2) AS `Retention Rate (%)`,<br>	(LAG(ROUND(AVG(DATEDIFF(s.second_purchase_date, f.first_purchase_date)), 0),1) over (order by f.cohort_year) -<br>	ROUND(AVG(DATEDIFF(s.second_purchase_date, f.first_purchase_date)), 0))/<br>	LAG(ROUND(AVG(DATEDIFF(s.second_purchase_date, f.first_purchase_date)), 0),1) over (order by f.cohort_year)*100<br>	'Annual improvement in first/second order timespan (%)'<br>	FROM FirstOrders f<br>LEFT JOIN SecondOrders s ON f.customer_id = s.customer_id<br>GROUP BY 1<br>order by 1</code></pre></th></tr><tr><th>Acquition year (Cohort)</th><th>Total aquired customers</th><th>Average days to second order</th><th>Retention Rate (%)</th><th>Annual improvement in first/second order timespan (%)</th></tr><tr class="odd"><td>2.014</td><td>595</td><td>292</td><td>99,83</td><td>&nbsp;</td></tr>
<tr><td>2.015</td><td>136</td><td>264</td><td>100</td><td>9,59</td></tr>
<tr class="odd"><td>2.016</td><td>51</td><td>180</td><td>90,2</td><td>31,82</td></tr>
<tr><td>2.017</td><td>11</td><td>105</td><td>45,45</td><td>41,67</td></tr>
</table></body></html>